From b08baadd829500fac417f46f86518ba8e3c8cb4c Mon Sep 17 00:00:00 2001
From: Tomas Hrcka <thrcka@redhat.com>
Date: Mon, 22 Jul 2013 16:15:06 +0200
Subject: [PATCH] RHBZ #983930 CVE-2013-4116 Insecure temporary directory generation

---
 lib/npm.js |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/lib/npm.js b/lib/npm.js
index 2028b34..1ccb78b 100644
--- a/lib/npm.js
+++ b/lib/npm.js
@@ -475,9 +475,14 @@ Object.defineProperty(npm, "cache",
   })
 
 var tmpFolder
+var crypto = require("crypto")
+var rand = crypto.randomBytes(6)
+                 .toString("base64")
+                 .replace(/\//g, '_')
+                 .replace(/\+/, '-') 
 Object.defineProperty(npm, "tmp",
   { get : function () {
-      if (!tmpFolder) tmpFolder = "npm-" + process.pid
+      if (!tmpFolder) tmpFolder = "npm-" + process.pid + "-" + rand
       return path.resolve(npm.config.get("tmp"), tmpFolder)
     }
   , enumerable : true
-- 
1.7.1

